<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> KVC & KVO 小结 · partyspy的技术博客</title><meta name="description" content="KVC &amp; KVO 小结 - partyspy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/partyspy.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/partyspy.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/partyspy" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/partyspy" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">KVC & KVO 小结</h1><div class="post-info">Jun 30, 2016</div><div class="post-content"><h2 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h2><h3 id="什么是KVC"><a href="#什么是KVC" class="headerlink" title="什么是KVC?"></a>什么是KVC?</h3><p>KVC(Key-value coding)是一种通过字符串去识别并间接存取(access)对象属性的机制, 该机制区别于直接通过存取方法(accessor)和实例变量去访问. 本质上, KVC定义了实现存取方法的模式与方法签名.</p>
<p>KVC可用来访问三种不同类型的对象值: attribute, 一对一关系, 一对多关系.</p>
<h3 id="KVC方法"><a href="#KVC方法" class="headerlink" title="KVC方法"></a>KVC方法</h3><h4 id="读"><a href="#读" class="headerlink" title="读:"></a>读:</h4><ul>
<li><code>-valueForKey:</code></li>
<li><code>-valueForKeyPath:</code></li>
<li><code>-dicitionaryWithValuesForKeys:</code></li>
</ul>
<p>对应key的值不存在时将发送消息<code>valueForUndefinedKey:</code>给自己, 该方法默认实现抛出<code>NSUndefinedKeyException</code>. 可自行重写该方法.</p>
<h4 id="写"><a href="#写" class="headerlink" title="写:"></a>写:</h4><ul>
<li><code>-setValue:ForKey:</code></li>
<li><code>-setValue:ForKeyPath:</code></li>
<li><code>-setValuesForKeysWithDicitonary:</code></li>
</ul>
<p>若指定的key不存在调用者将被发送消息<code>setValue:forUndefinedKey:</code>, 同样该方法默认抛出<code>NSUndefinedKeyException</code>.</p>
<p>若把nil赋给一个非对象类型的属性, 调用者被发送<code>setNilValueForKey:</code>消息, 该方法默认抛出<code>NSInvalidArgumentException.</code> 自己可重写该方法来实现正确的赋值. 例如:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyModel.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hidden;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">NSInteger</span> num;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MyModel.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyModel</span></span></span><br><span class="line">- (<span class="keyword">void</span>)setNilValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"num"</span>]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setValue:@<span class="number">0</span> forKey:<span class="string">@"num"</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"hidden"</span>]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setValue:@NO forKey:<span class="string">@"hidden"</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> setNilValueForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="KVC与点语法访问方法"><a href="#KVC与点语法访问方法" class="headerlink" title="KVC与点语法访问方法"></a>KVC与点语法访问方法</h3><p>两种方法可同时并存使用.<br>如下例所示, 定义了一个类:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSString</span> *stringProperty;</span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSInteger</span> integerProperty;</span><br><span class="line"><span class="keyword">@property</span> MyClass *linkedInstance;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>用KVC访问属性如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MyClass *myInstance = [[MyClass alloc] init];</span><br><span class="line"><span class="built_in">NSString</span> *string = [myInstance valueForKey:<span class="string">@"stringProperty"</span>];</span><br><span class="line">[myInstance setValue:@<span class="number">2</span> forKey:<span class="string">@"integerProperty"</span>];</span><br></pre></td></tr></table></figure>
<p>以下两种方式结果是一样的:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MyClass *anotherInstance = [[MyClass alloc] init];</span><br><span class="line">myInstance.linkedInstance = anotherInstance;</span><br><span class="line">myInstance.linkedInstance.integerProperty = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MyClass *anotherInstance = [[MyClass alloc] init];</span><br><span class="line">myInstance.linkedInstance = anotherInstance;</span><br><span class="line">[myInstance setValue:@<span class="number">2</span> forKeyPath:<span class="string">@"linkedInstance.integerProperty"</span>];</span><br></pre></td></tr></table></figure>
<h3 id="KVC兼容-Key-value-coding-compliant"><a href="#KVC兼容-Key-value-coding-compliant" class="headerlink" title="KVC兼容(Key-value coding compliant)"></a>KVC兼容(Key-value coding compliant)</h3><p>KVC兼容是对于类中某个特定属性(property)来说的, 所谓KVC兼容实际指的是某个属性可通过<code>-valueForKey:</code>, <code>-setValue:forKey:</code><strong>等</strong>KVC方法去访问属性. </p>
<p>在Objective-C 2.0里的@property实质上也就是一对setter, getter访问器方法加一个实例变量. </p>
<h5 id="先看个例子"><a href="#先看个例子" class="headerlink" title="先看个例子:"></a>先看个例子:</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyModel.m</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSObject</span> *_myObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSObject</span> *)myObj &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_myObj) &#123;</span><br><span class="line">        _myObj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _myObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setMyObj:(<span class="built_in">NSObject</span> *)obj &#123;</span><br><span class="line">    _myObj = obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>调用时,</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"MyModel myObj: %@"</span>, model.myObj);</span><br><span class="line"><span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"auto obj: %@"</span>, obj);</span><br><span class="line">[model setValue:obj forKey:<span class="string">@"myObj"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"MyModel myObj: %@"</span>, model.myObj);</span><br></pre></td></tr></table></figure>
<p>打印出来:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span><span class="number">-06</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">26.991</span> TestKVC[<span class="number">19217</span>:<span class="number">20399799</span>] MyModel myObj: &lt;<span class="built_in">NSObject</span>: <span class="number">0x7fea43424fe0</span>&gt;</span><br><span class="line"><span class="number">2016</span><span class="number">-06</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">26.991</span> TestKVC[<span class="number">19217</span>:<span class="number">20399799</span>] auto obj: &lt;<span class="built_in">NSObject</span>: <span class="number">0x7fea45813d90</span>&gt;</span><br><span class="line"><span class="number">2016</span><span class="number">-06</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">26.991</span> TestKVC[<span class="number">19217</span>:<span class="number">20399799</span>] MyModel myObj: &lt;<span class="built_in">NSObject</span>: <span class="number">0x7fea45813d90</span>&gt;</span><br></pre></td></tr></table></figure>
<p>以上, 对于myObj这个属性来说, 它就是KVC兼容的.</p>
<p>其实, 没有实例变量也是可以的.</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyModel.m</span></span><br><span class="line">...</span><br><span class="line">- (<span class="built_in">NSObject</span> *)noSuchObj &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"getter method"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNoSuchObj:(<span class="built_in">NSObject</span> *)obj &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"setter method"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用时,</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//invoke getter accessor</span></span><br><span class="line">[model valueForKey:<span class="string">@"noSuchObj"</span>];</span><br><span class="line"><span class="comment">//invoke setter accessor</span></span><br><span class="line">[model setValue:<span class="string">@"nothing"</span> forKey:<span class="string">@"noSuchObj"</span>];</span><br><span class="line"><span class="comment">//same as the above one for dot syntax</span></span><br><span class="line">model.noSuchObj = <span class="string">@"nothing"</span>;</span><br></pre></td></tr></table></figure>
<p>打印出来是, </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span><span class="number">-06</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">26.992</span> TestKVC[<span class="number">19217</span>:<span class="number">20399799</span>] getter method</span><br><span class="line"><span class="number">2016</span><span class="number">-06</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">31.439</span> TestKVC[<span class="number">19217</span>:<span class="number">20399799</span>] setter method</span><br><span class="line"><span class="number">2016</span><span class="number">-06</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">38.882</span> TestKVC[<span class="number">19217</span>:<span class="number">20399799</span>] setter method</span><br></pre></td></tr></table></figure>
<p>实际上<code>-valueForKey:</code>, <code>-setValue:forKey:</code>之类的KVC方法在运行时会按照一定的顺序去调用遵循特定方法签名的访问器方法或直接访问实例变量.</p>
<p>例如<code>-setValue:forKey:</code>这个方法的实现大概是这样的:</p>
<ul>
<li>查看调用对象所属类是否实现了<code>-set&lt;Key&gt;:</code>这样的访问器方法, 有则调用;</li>
<li>若没有, 调用者类方法<code>-accessInstanceVariablesDirectly</code>放回YES, 然后依次搜索看是否存在命名方式为 <code>_&lt;key&gt;</code>, <code>_is&lt;Key&gt;</code>, <code>&lt;key&gt;</code>, <code>is&lt;Key&gt;</code>这样的实例变量, 有则直接赋值于它.</li>
<li>若遵循这种命名形式的访问器方法和实例变量都无, 则调用<code>setValue:forUndefinedKey:</code>方法.</li>
</ul>
<h3 id="一对多关系属性的KVC-集合代理"><a href="#一对多关系属性的KVC-集合代理" class="headerlink" title="一对多关系属性的KVC, 集合代理"></a>一对多关系属性的KVC, 集合代理</h3><p>先看个例子:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyModel.m</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> int32_t <span class="keyword">const</span> primes[] = &#123;</span><br><span class="line">    <span class="number">2</span>, <span class="number">101</span>, <span class="number">233</span>, <span class="number">383</span>, <span class="number">3</span>, <span class="number">103</span>, <span class="number">239</span>, <span class="number">389</span>, <span class="number">5</span>, <span class="number">107</span>, <span class="number">241</span>, <span class="number">397</span>, <span class="number">7</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">251</span>, <span class="number">401</span>, <span class="number">11</span>, <span class="number">113</span>, <span class="number">257</span>, <span class="number">409</span>, <span class="number">13</span>, <span class="number">127</span>, <span class="number">263</span>, <span class="number">419</span>, <span class="number">17</span>, <span class="number">131</span>, <span class="number">269</span>,</span><br><span class="line">    <span class="number">421</span>, <span class="number">19</span>, <span class="number">137</span>, <span class="number">271</span>, <span class="number">431</span>, <span class="number">23</span>, <span class="number">139</span>, <span class="number">277</span>, <span class="number">433</span>, <span class="number">29</span>, <span class="number">149</span>, <span class="number">281</span>, <span class="number">439</span>,</span><br><span class="line">    <span class="number">31</span>, <span class="number">151</span>, <span class="number">283</span>, <span class="number">443</span>, <span class="number">37</span>, <span class="number">157</span>, <span class="number">293</span>, <span class="number">449</span>, <span class="number">41</span>, <span class="number">163</span>, <span class="number">307</span>, <span class="number">457</span>, <span class="number">43</span>,</span><br><span class="line">    <span class="number">167</span>, <span class="number">311</span>, <span class="number">461</span>, <span class="number">47</span>, <span class="number">173</span>, <span class="number">313</span>, <span class="number">463</span>, <span class="number">53</span>, <span class="number">179</span>, <span class="number">317</span>, <span class="number">467</span>, <span class="number">59</span>, <span class="number">181</span>,</span><br><span class="line">    <span class="number">331</span>, <span class="number">479</span>, <span class="number">61</span>, <span class="number">191</span>, <span class="number">337</span>, <span class="number">487</span>, <span class="number">67</span>, <span class="number">193</span>, <span class="number">347</span>, <span class="number">491</span>, <span class="number">71</span>, <span class="number">197</span>, <span class="number">349</span>,</span><br><span class="line">    <span class="number">499</span>, <span class="number">73</span>, <span class="number">199</span>, <span class="number">353</span>, <span class="number">503</span>, <span class="number">79</span>, <span class="number">211</span>, <span class="number">359</span>, <span class="number">509</span>, <span class="number">83</span>, <span class="number">223</span>, <span class="number">367</span>, <span class="number">521</span>,</span><br><span class="line">    <span class="number">89</span>, <span class="number">227</span>, <span class="number">373</span>, <span class="number">523</span>, <span class="number">97</span>, <span class="number">229</span>, <span class="number">379</span>, <span class="number">541</span>, <span class="number">547</span>, <span class="number">701</span>, <span class="number">877</span>, <span class="number">1049</span>,</span><br><span class="line">    <span class="number">557</span>, <span class="number">709</span>, <span class="number">881</span>, <span class="number">1051</span>, <span class="number">563</span>, <span class="number">719</span>, <span class="number">883</span>, <span class="number">1061</span>, <span class="number">569</span>, <span class="number">727</span>, <span class="number">887</span>,</span><br><span class="line">    <span class="number">1063</span>, <span class="number">571</span>, <span class="number">733</span>, <span class="number">907</span>, <span class="number">1069</span>, <span class="number">577</span>, <span class="number">739</span>, <span class="number">911</span>, <span class="number">1087</span>, <span class="number">587</span>, <span class="number">743</span>,</span><br><span class="line">    <span class="number">919</span>, <span class="number">1091</span>, <span class="number">593</span>, <span class="number">751</span>, <span class="number">929</span>, <span class="number">1093</span>, <span class="number">599</span>, <span class="number">757</span>, <span class="number">937</span>, <span class="number">1097</span>, <span class="number">601</span>,</span><br><span class="line">    <span class="number">761</span>, <span class="number">941</span>, <span class="number">1103</span>, <span class="number">607</span>, <span class="number">769</span>, <span class="number">947</span>, <span class="number">1109</span>, <span class="number">613</span>, <span class="number">773</span>, <span class="number">953</span>, <span class="number">1117</span>,</span><br><span class="line">    <span class="number">617</span>, <span class="number">787</span>, <span class="number">967</span>, <span class="number">1123</span>, <span class="number">619</span>, <span class="number">797</span>, <span class="number">971</span>, <span class="number">1129</span>, <span class="number">631</span>, <span class="number">809</span>, <span class="number">977</span>,</span><br><span class="line">    <span class="number">1151</span>, <span class="number">641</span>, <span class="number">811</span>, <span class="number">983</span>, <span class="number">1153</span>, <span class="number">643</span>, <span class="number">821</span>, <span class="number">991</span>, <span class="number">1163</span>, <span class="number">647</span>, <span class="number">823</span>,</span><br><span class="line">    <span class="number">997</span>, <span class="number">1171</span>, <span class="number">653</span>, <span class="number">827</span>, <span class="number">1009</span>, <span class="number">1181</span>, <span class="number">659</span>, <span class="number">829</span>, <span class="number">1013</span>, <span class="number">1187</span>, <span class="number">661</span>,</span><br><span class="line">    <span class="number">839</span>, <span class="number">1019</span>, <span class="number">1193</span>, <span class="number">673</span>, <span class="number">853</span>, <span class="number">1021</span>, <span class="number">1201</span>, <span class="number">677</span>, <span class="number">857</span>, <span class="number">1031</span>,</span><br><span class="line">    <span class="number">1213</span>, <span class="number">683</span>, <span class="number">859</span>, <span class="number">1033</span>, <span class="number">1217</span>, <span class="number">691</span>, <span class="number">863</span>, <span class="number">1039</span>, <span class="number">1223</span>, <span class="number">1229</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)countOfPrimes;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">sizeof</span>(primes) / <span class="keyword">sizeof</span>(*primes));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)objectInPrimesAtIndex:(<span class="built_in">NSUInteger</span>)idx;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(idx &lt; <span class="keyword">sizeof</span>(primes) / <span class="keyword">sizeof</span>(*primes));</span><br><span class="line">    <span class="keyword">return</span> @(primes[idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述MyModel类的实现文件里, 加上了一个装有一堆质数的静态数组, 以及定义了两个方法. </p>
<p>瞧这两方法是否看起来类似于NSArray的原始(primitive)方法 <code>-count</code>和<code>-objectAtInIndex:</code>呢?</p>
<p>使用时:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//invoke collection accessors</span></span><br><span class="line"><span class="keyword">id</span> proxy = [model valueForKey:<span class="string">@"primes"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"MyModel last prime: %@"</span>, [proxy lastObject]);</span><br></pre></td></tr></table></figure>
<p>这里我们是把<code>primes</code>当做一个NSArray来使用的. 注意上面例子中并没有声明有<code>primes</code>这么一个属性的, 也无这么一个实例变量对象. 我们可以通过<code>valueForKey:</code>去获取, 那么它一定是实现KVC了.</p>
<p>实际上, 这里<code>valueForKey:</code>方法内部大概是这样的:</p>
<ul>
<li>依次查找<code>get&lt;Key&gt;</code>, <code>&lt;key&gt;</code>, <code>is&lt;Key&gt;</code>形式的访问器方法.</li>
<li>找不到则查找匹配模式<code>countOf&lt;Key&gt;</code>和<code>objectIn&lt;Key&gt;AtIndex:</code>(或<code>objectsAtIndexes:</code>)的方法. 若找到, 则返回一个集合代理对象(<strong>collection proxy object</strong>), 该对象可使用所有NSArray的方法.</li>
<li>找不到则查找<code>countOf&lt;Key&gt;</code>, <code>enumeratorOf&lt;Key&gt;</code>, <code>memberOf&lt;Key&gt;:</code>, 同理如上, 不过对应的是<strong>NSSet</strong>, 无序集合.</li>
<li>再找不到则查找匹配命名<code>_&lt;key&gt;</code>, <code>_is&lt;Key&gt;</code>, <code>&lt;key&gt;</code>, or <code>is&lt;Key&gt;</code>的实例变量.</li>
<li>否则调用<code>valueForUndefinedKey:</code>.</li>
</ul>
<p>上例中的proxy就是一个集合代理对象, 调用<code>[proxy class]</code>得知它是一个<strong>NSKeyValueArray</strong>类型.</p>
<blockquote>
<p>集合代理对象里, 包括了有序与无序, 可变与不可变的不同情况, 其分别也对应于实现不同的方法以KVC兼容. 但它们机理都是类似的.</p>
</blockquote>
<h3 id="集合运算符"><a href="#集合运算符" class="headerlink" title="集合运算符"></a>集合运算符</h3><p><img src="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueCoding/art/keypath.jpg" alt="Operator key path format"></p>
<ul>
<li>简单运算符:@avg, @count, @max, @min. @sum.</li>
<li>对象运算符:@distinctUnionOfObjects, @unionOfObjects.</li>
<li>数组,集合运算符:@distinctUnionOfArrays, @unionOfArrays, @distinctUnionOfSets.</li>
</ul>
<p>上例中,</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> proxy = [model valueForKey:<span class="string">@"primes"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"MyModel primes count: %lu"</span>, [proxy count]);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"MyModel primes count: %@"</span>, [model valueForKeyPath:<span class="string">@"primes.@count"</span>]);</span><br></pre></td></tr></table></figure>
<p>打印的两个count结果都是一样的, 都是<code>201</code>.</p>
<h2 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h2><p>接收一个属性的KVO通知, 需三个条件:</p>
<ul>
<li>被观察的属性是<strong>KVO兼容</strong>的.(KVO Compliant)</li>
<li>注册观察者:发送消息<code>addObserver:forKeyPath:options:context:</code>到被观察对象.</li>
<li>观察着对象需实现<code>observeValueForKeyPath:ofObject:change:context:</code>方法.</li>
</ul>
<p>而属性为KVO兼容的, 亦需满足三个条件:</p>
<ul>
<li>它是KVC兼容的;</li>
<li>所在类会为该属性发送KVO通知;</li>
<li>依赖键需注册.</li>
</ul>
<p>看个例子. 以下两方法都在都一观察者类中, self即observer.</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 观察者类中注册键值观察</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)registerAsObserver &#123;</span><br><span class="line">    <span class="keyword">self</span>.model = [[MyModel alloc] init];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.model addObserver:<span class="keyword">self</span></span><br><span class="line">            forKeyPath:<span class="string">@"num"</span></span><br><span class="line">               options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span></span><br><span class="line">               context:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">3</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [<span class="keyword">self</span>.model setValue:<span class="string">@"999"</span> forKey:<span class="string">@"num"</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现处理KVO通知方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(<span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">self</span>.model) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"num"</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"old num:%@"</span>, change[<span class="built_in">NSKeyValueChangeOldKey</span>]);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"new num:%@"</span>, change[<span class="built_in">NSKeyValueChangeNewKey</span>]);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里打印被观察属性值变化的新旧值.</p>
<h3 id="KVO的自动与手动通知"><a href="#KVO的自动与手动通知" class="headerlink" title="KVO的自动与手动通知"></a>KVO的自动与手动通知</h3><p>以上例子为自动通知. 实际上苹果系统framework中类的属性都支持发送自动通知.</p>
<p>而手动通知可实现精细的控制通知发送. 手动通知通过重写NSObject的<code>automaticallyNotifiesObserversForKey:</code>方法判断是否自动.</p>
<p>用法如下例所示:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyModel.m</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"num"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>NO</code>表示键为<code>num</code>的属性为手动KVO.<br>重写其setter方法:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MyModel.m</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNum:(<span class="built_in">NSInteger</span>)num &#123;</span><br><span class="line">    <span class="keyword">if</span> (num != _num) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"num"</span>];</span><br><span class="line">        _num = num;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"num"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料:"></a>参考资料:</h3><p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177-BCICJDHA" target="_blank" rel="external">Key-Value Observing Programming Guide</a></p>
<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueCoding/Articles/KeyValueCoding.html#//apple_ref/doc/uid/10000107-SW1" target="_blank" rel="external">Key-Value Coding Programming Guide</a></p>
<p><a href="http://objccn.io/issue-7-3/" target="_blank" rel="external">KVC 和 KVO objc中国</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/02/Objective-C Rumtime(一)- 初探/" class="prev">PREV</a><a href="/2016/06/14/tableView性能优化/" class="next">NEXT</a></div><div data-thread-key="2016/06/30/KVC &amp; KVO 小结/" data-title="KVC &amp; KVO 小结" data-url="http://yoursite.com/2016/06/30/KVC &amp; KVO 小结/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"partyspy"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">partyspy</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>